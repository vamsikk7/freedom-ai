services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: freedom-ai-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: freedom_ai_management
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: freedom-ai-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: freedom-ai-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI port
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Management Server (Go Application)
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: freedom-ai-server
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Server Configuration
      PORT: 8080
      ENVIRONMENT: production
      
      # Database
      MONGODB_URI: mongodb://mongodb:27017
      MONGODB_DATABASE: freedom_ai_management
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      REDIS_DB: 0
      
      # RabbitMQ
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      RABBITMQ_EXCHANGE: llm-events
      
      # SuperTokens (optional - can be external)
      SUPERTOKENS_CONNECTION_URI: ${SUPERTOKENS_CONNECTION_URI:-http://localhost:3567}
      SUPERTOKENS_API_KEY: ${SUPERTOKENS_API_KEY:-}
      SUPERTOKENS_API_DOMAIN: ${SUPERTOKENS_API_DOMAIN:-localhost}
      
      # Super Admin
      SUPER_ADMIN_EMAIL: ${SUPER_ADMIN_EMAIL:-admin@freedom-ai.com}
      SUPER_ADMIN_PASSWORD: ${SUPER_ADMIN_PASSWORD:-changeme123}
      
      # Stripe (optional)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      
      # Pricing (per 1k tokens)
      PRICING_GPT4_REQUEST: ${PRICING_GPT4_REQUEST:-0.03}
      PRICING_GPT4_RESPONSE: ${PRICING_GPT4_RESPONSE:-0.06}
      PRICING_GPT4_TURBO_REQUEST: ${PRICING_GPT4_TURBO_REQUEST:-0.01}
      PRICING_GPT4_TURBO_RESPONSE: ${PRICING_GPT4_TURBO_RESPONSE:-0.03}
      PRICING_GPT35_TURBO_REQUEST: ${PRICING_GPT35_TURBO_REQUEST:-0.0015}
      PRICING_GPT35_TURBO_RESPONSE: ${PRICING_GPT35_TURBO_RESPONSE:-0.002}
      
      # CORS
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      
      # SMTP (optional)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@freedom-ai.com}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - freedom-ai-network

volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local

networks:
  freedom-ai-network:
    driver: bridge

